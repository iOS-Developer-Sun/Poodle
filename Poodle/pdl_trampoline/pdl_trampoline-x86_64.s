//
//  pdl_trampoline-x86_64.s
//  Poodle
//
//  Created by Poodle on 11-8-23.
//  Copyright Â© 2021 Poodle. All rights reserved.
//

#include "pdl_asm-universal.h"

#ifdef __x86_64__

#include <mach/vm_param.h>

.text

.private_extern _pdl_trampoline_page_begin
.private_extern _pdl_trampoline_page_stubs
.private_extern _pdl_trampoline_page_end
.private_extern _pdl_trampoline_entry

.align PAGE_MAX_SHIFT

.macro PDL_TRAMPOLINE_STUB
nop // 1 byte
nop
nop
callq _pdl_trampoline_page_begin // 5 bytes
jmp *(%r11) // 3 bytes
nop
nop
nop
nop
nop
.endmacro

.macro PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB

PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB

PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB

PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
.endmacro

.macro PDL_TRAMPOLINE_STUB_256
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16

PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16

PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16

PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
.endmacro

_pdl_trampoline_page_begin:
movq (%rsp), %r11 // 4
addq $-PAGE_MAX_SIZE - 8, %r11 // 6
ret // 1
nop // 1
nop
nop
nop
nop

_pdl_trampoline_page_stubs:

// 2045
PDL_TRAMPOLINE_STUB_256
PDL_TRAMPOLINE_STUB_256
PDL_TRAMPOLINE_STUB_256
PDL_TRAMPOLINE_STUB_256

PDL_TRAMPOLINE_STUB_256
PDL_TRAMPOLINE_STUB_256
PDL_TRAMPOLINE_STUB_256

PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16

PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16

PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16

PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16
PDL_TRAMPOLINE_STUB_16

PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB

PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB

PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB

PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB
PDL_TRAMPOLINE_STUB

_pdl_trampoline_page_end:

.align PAGE_MAX_SHIFT

_pdl_trampoline_entry:
    PDL_ASM_OBJC_MESSAGE_STATE_SAVE NORMAL
    movq    0x8(%rbp), %rsi
    movq    %r11, %rdi
    call    _pdl_trampoline_before
    movq    %rax, %r11
    PDL_ASM_OBJC_MESSAGE_STATE_RESTORE NORMAL
    popq    %r10
    call     *%r11
    pushq   %rax
    PDL_ASM_OBJC_MESSAGE_STATE_SAVE NORMAL
    call    _pdl_trampoline_after
    mov     %rax, %r11
    PDL_ASM_OBJC_MESSAGE_STATE_RESTORE NORMAL
    popq    %rax
    pushq   %r11
    ret

#endif
